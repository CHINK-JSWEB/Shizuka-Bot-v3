// cmds/neko.js
const axios = require("axios");
const fs = require("fs-extra");
const path = require("path");

module.exports = {
  config: {
    name: "neko",
    version: "1.0",
    author: "Nikox",
    description: "Send random neko image",
    category: "anime",
    role: 0,
    usePrefix: true
  },

  onStart: async function ({ message }) {
    const tempFile = path.join(__dirname, "..", "cache", `neko_${Date.now()}.jpg`);

    try {
      const { data } = await axios.get("https://rapido.zetsu.xyz/api/ba");
      if (!data?.data) {
        const errMsg = await message.reply("❌ Walang nakuha na image.");
        setTimeout(() => message.unsend(errMsg.messageID), 5000);
        return;
      }

      const response = await axios.get(data.data, { responseType: "stream" });
      const writer = fs.createWriteStream(tempFile);
      response.data.pipe(writer);

      writer.on("finish", () => {
        message.reply({
          body: "😺 Random Neko!",
          attachment: fs.createReadStream(tempFile)
        }, () => fs.unlinkSync(tempFile)); // delete after sending
      });

      writer.on("error", async () => {
        const errMsg = await message.reply("❌ Error saving image.");
        setTimeout(() => message.unsend(errMsg.messageID), 5000);
      });

    } catch (e) {
      console.error("❌ Neko Error:", e);
      const errMsg = await message.reply("❌ Error fetching image.");
      setTimeout(() => message.unsend(errMsg.messageID), 5000);
    }
  }
};
