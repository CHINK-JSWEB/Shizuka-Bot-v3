const fs = require("fs");
const path = require("path");

module.exports = {
  name: "event",

  async execute({ api, event }) {
    if (event.logMessageType === "log:subscribe") {
      try {
        const threadInfo = await api.getThreadInfo(event.threadID);
        const totalMembers = threadInfo.participantIDs.length;
        const botID = api.getCurrentUserID();

        const newUsers = event.logMessageData.addedParticipants;
        for (const user of newUsers) {
          const userID = user.userFbId;
          const userName = user.fullName || "Bagong Miyembro";

          const mentions = [
            { tag: `@${userName}`, id: userID },
            { tag: "@Arnel Masibog", id: "61556131864949" }
          ];

          const message = {
            body: `👋 Hey @${userName}! Welcome to the group! 🎉

👥 We’re now ${totalMembers} members strong and growing like a happy family! 💚

Here, we laugh, share, and support each other like siblings. Feel at home, be yourself, and enjoy the fun vibes! ✨

🧑‍💻 [Admin] @Arnel Masibog is always around if you ever need help or just want to say hi!

Welcome to the barkada! 🫶`,
            mentions
          };

          const videoPath = path.join(__dirname, "..", "assets", "welcome.mp4");
          if (fs.existsSync(videoPath)) {
            message.attachment = fs.createReadStream(videoPath);
          }

          await api.sendMessage(message, event.threadID);

          // Nickname the bot if it was added
          if (userID === botID) {
            await api.changeNickname("🤖 Arnel Assistant", event.threadID, botID);
          }
        }
      } catch (err) {
        console.error("❌ Error in welcome event:", err);
      }
    }
  }
};
